<%= render_breadcrumbs([
  bc("ホーム", root_path),
  bc("参加可能時間")
]) %>

<%# ========== 曜日（0=日, ... 6=土）に統一（Date#wday） ========== %>
<% wday_en = %w[Sunday Monday Tuesday Wednesday Thursday Friday Saturday] %>
<% wday_jp = %w[日曜日 月曜日 火曜日 水曜日 木曜日 金曜日 土曜日] %>
<% wdays_order = (0..6).to_a %>

<%# ========== 時刻オプション（30分刻み） ========== %>
<% time_options =
  (0..47).map do |i|
    m = i * 30
    label = format("%02d:%02d", m / 60, m % 60)
    [label, label]
  end
%>
<% end_time_options = time_options + [["24:00", "24:00"]] %>

<%# ========== start_minute/end_minute を "HH:MM" に変換して selected を確実に当てる ========== %>
<% minute_to_hhmm = ->(m) { format("%02d:%02d", m / 60, m % 60) } %>
<% selected_hhmm = ->(obj, minute_attr, fallback_attr) do
  if obj.respond_to?(minute_attr) && !obj.public_send(minute_attr).nil?
    minute_to_hhmm.call(obj.public_send(minute_attr))
  else
    obj.public_send(fallback_attr).to_s
  end
end %>

<%# controller でセットされる想定 %>
<% @category ||= (params[:category].presence || "tech") %>
<% @slots_by_wday ||= {} %>

<div class="mx-auto max-w-4xl px-4 py-8 space-y-8"
     data-controller="availability-draft availability-slots"
     data-availability-draft-category-value="<%= @category %>"
     data-availability-draft-clear-value="<%= flash[:notice].present? %>">

  <%# ===== 説明カード ===== %>
  <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 sm:p-8 bg-gradient-to-r from-purple-50/50 to-blue-50/50">
    <h1 class="text-2xl font-bold text-gray-900 mb-3">参加可能時間の登録</h1>
    <p class="text-gray-600 text-sm leading-relaxed">
      毎週参加できる時間帯を曜日ごとに登録してください。<span class="text-primary font-medium cursor-pointer hover:underline">登録した時間帯は人数集計としてのみ表示</span>され、個人の予定は公開されません。
    </p>
  </div>

  <%# ===== カテゴリ切り替えタブ ===== %>
  <div class="space-y-4">
    <div class="flex items-center gap-2 text-gray-700 font-medium">
      <span class="material-icons-outlined text-lg">format_list_bulleted</span>
      <h2>カテゴリを選択してください</h2>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <%# 技術系カード %>
      <%= link_to profile_availability_slots_path(category: "tech"),
        class: "relative group cursor-pointer",
        data: { action: "click->availability-draft#switch", category: "tech" } do %>
        <% if @category == 'tech' %>
          <div class="absolute -top-2 -right-2 bg-white rounded-full p-0.5 shadow-md z-10">
            <span class="material-icons-outlined text-indigo-600 text-xl bg-indigo-100 rounded-full">check_circle</span>
          </div>
        <% end %>
        <div class="<%= @category == 'tech' ? 'bg-indigo-600 text-white shadow-lg ring-2 ring-indigo-600 ring-offset-2' : 'bg-white border border-gray-200 hover:border-indigo-400 hover:bg-indigo-50' %> rounded-xl p-6 flex flex-col items-center justify-center text-center h-40 transition-all transform hover:scale-[1.01]">
          <span class="material-icons-outlined text-5xl mb-3 <%= @category == 'tech' ? '' : 'text-indigo-600' %>">monitor</span>
          <h3 class="text-xl font-bold mb-1 <%= @category == 'tech' ? '' : 'text-gray-900' %>"><%= Theme.human_enum_name(:category, "tech") %></h3>
          <p class="<%= @category == 'tech' ? 'text-indigo-200' : 'text-gray-500' %> text-sm">技術勉強会向け</p>
        </div>
      <% end %>

      <%# 交流系カード %>
      <%= link_to profile_availability_slots_path(category: "community"),
        class: "cursor-pointer group",
        data: { action: "click->availability-draft#switch", category: "community" } do %>
        <% if @category == 'community' %>
          <div class="absolute -top-2 -right-2 bg-white rounded-full p-0.5 shadow-md z-10">
            <span class="material-icons-outlined text-emerald-600 text-xl bg-emerald-100 rounded-full">check_circle</span>
          </div>
        <% end %>
        <div class="<%= @category == 'community' ? 'bg-emerald-600 text-white shadow-lg ring-2 ring-emerald-600 ring-offset-2' : 'bg-white border border-gray-200 hover:border-emerald-400 hover:bg-emerald-50' %> rounded-xl p-6 flex flex-col items-center justify-center text-center h-40 transition-all">
          <span class="material-icons-outlined text-5xl mb-3 <%= @category == 'community' ? '' : 'text-emerald-600' %>">groups</span>
          <h3 class="text-xl font-bold mb-1 <%= @category == 'community' ? '' : 'text-gray-900 group-hover:text-emerald-600' %>"><%= Theme.human_enum_name(:category, "community") %></h3>
          <p class="<%= @category == 'community' ? 'text-emerald-100' : 'text-gray-500 group-hover:text-emerald-500' %> text-sm">交流イベント向け</p>
        </div>
      <% end %>
    </div>
  </div>

  <%# ===== 一括登録ショートカット ===== %>
  <div class="bg-gradient-to-r from-gray-50 to-white rounded-2xl border-2 border-dashed border-gray-300 p-6 flex flex-col sm:flex-row items-center justify-between gap-4 transition-all hover:border-primary/50 group">
    <div class="flex items-start gap-4">
      <div class="p-3 bg-primary/10 rounded-full text-primary">
        <span class="material-icons-outlined text-2xl">date_range</span>
      </div>
      <div>
        <h3 class="font-bold text-lg text-gray-900">一括登録ショートカット</h3>
        <p class="text-sm text-gray-500 mt-1">
          複数の曜日をまとめて選択し、同じ時間帯を一気に登録できます。
        </p>
      </div>
    </div>
    <button type="button"
            class="w-full sm:w-auto px-6 py-3 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 hover:text-primary hover:border-primary transition-all shadow-sm flex items-center justify-center gap-2 group-hover:shadow-md whitespace-nowrap"
            onclick="bulkAddModal.showModal()">
      <span class="material-icons-outlined text-xl">playlist_add</span>
      曜日を選択してまとめて追加
    </button>
  </div>

  <%# ===== 削除ボタン ===== %>
  <div class="flex justify-end">
    <%= button_to destroy_all_profile_availability_slots_path,
          method: :delete,
          params: { category: @category },
          data: { turbo_confirm: "「#{Theme.human_enum_name(:category, @category)}」の参加可能時間をすべて削除します。よろしいですか？" },
          class: "text-sm text-white bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg font-medium transition-colors shadow-sm flex items-center gap-1" do %>
      <span class="material-icons-outlined text-base">delete_sweep</span>
      <%= "#{Theme.human_enum_name(:category, @category)}の登録をすべて削除" %>
    <% end %>
  </div>

  <%# ===== 一括追加モーダル ===== %>
  <dialog id="bulkAddModal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-3">まとめて追加</h3>

      <%= form_with url: bulk_create_profile_availability_slots_path, method: :post do %>
        <%= hidden_field_tag "bulk[category]", @category %>

        <div class="space-y-4">
          <div>
            <div class="label"><span class="label-text">対象曜日（複数選択）</span></div>
            <div class="flex flex-wrap gap-3">
              <% %w[日 月 火 水 木 金 土].each_with_index do |label, i| %>
                <label class="flex items-center gap-2">
                  <input type="checkbox" class="checkbox" name="bulk[wdays][]" value="<%= i %>">
                  <span><%= label %></span>
                </label>
              <% end %>
            </div>
          </div>

          <% modal_time_options =
            (0..47).map do |i|
              m = i * 30
              label = format("%02d:%02d", m / 60, m % 60)
              [label, label]
            end
          %>
          <% modal_end_time_options = modal_time_options + [["24:00", "24:00"]] %>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <div class="label"><span class="label-text">開始時刻</span></div>
              <%= select_tag "bulk[start_time]",
                    options_for_select(modal_time_options),
                    include_blank: true,
                    class: "select select-bordered w-full" %>
            </div>

            <div>
              <div class="label"><span class="label-text">終了時刻</span></div>
              <%= select_tag "bulk[end_time]",
                    options_for_select(modal_end_time_options),
                    include_blank: true,
                    class: "select select-bordered w-full" %>
            </div>
          </div>
        </div>

        <div class="modal-action">
          <button type="button" class="btn" onclick="bulkAddModal.close()">キャンセル</button>
          <button type="submit" class="btn btn-primary">追加する</button>
        </div>
      <% end %>
    </div>

    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>


  <% if flash[:alert].present? %>
    <div class="alert alert-error"><div><%= flash[:alert] %></div></div>
  <% end %>

  <%# ===== 一括保存フォーム（Turbo無効で安定） ===== %>
  <%= form_with url: bulk_update_profile_availability_slots_path,
                method: :patch,
                id: "weekly-availability-form",
                local: true,
                class: "space-y-6" do %>

    <%= hidden_field_tag :category, @category %>

    <% wdays_order.each do |wday| %>
      <% slots = (@slots_by_wday[wday] || []) %>

      <div class="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50/50">
          <div class="flex items-center gap-2">
            <span class="font-bold text-gray-900 text-lg"><%= "#{wday_en[wday]} / #{wday_jp[wday]}" %></span>
          </div>

          <button type="button"
                  class="text-primary hover:text-primary/80 font-medium text-sm flex items-center gap-1 px-3 py-1.5 rounded-md hover:bg-primary/5 transition-colors"
                  data-action="click->availability-slots#add"
                  data-availability-slots-wday-param="<%= wday %>">
            <span class="material-icons-outlined text-lg">add_circle_outline</span>
            時間を追加
          </button>
        </div>

        <%# ★追加先：この div に行をappendする %>
        <div class="px-6 py-6 space-y-4" data-slot-list="<%= wday %>">
          <%# ===== 既存スロット（編集 + 削除） ===== %>
          <% if slots.any? %>
            <% slots.each do |slot| %>
              <div class="flex items-end gap-3">
                <div class="flex-1 grid gap-4 sm:grid-cols-2">
                  <%= fields_for "slots[#{slot.id}]", slot do |sf| %>
                    <div>
                      <label class="label">
                        <span class="label-text text-xs font-semibold tracking-wide text-gray-500">開始時刻</span>
                      </label>
                      <div class="relative">
                        <%= sf.select :start_time, time_options,
                          { selected: selected_hhmm.call(sf.object, :start_minute, :start_time) },
                          class: "select select-bordered w-full pr-10" %>
                        <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-gray-400">
                          <span class="material-icons-outlined text-base">schedule</span>
                        </div>
                      </div>
                    </div>

                    <div>
                      <label class="label">
                        <span class="label-text text-xs font-semibold tracking-wide text-gray-500">終了時刻</span>
                      </label>
                      <div class="relative">
                        <%= sf.select :end_time, end_time_options,
                          { selected: selected_hhmm.call(sf.object, :end_minute, :end_time) },
                          class: "select select-bordered w-full pr-10" %>
                        <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-gray-400">
                          <span class="material-icons-outlined text-base">schedule</span>
                        </div>
                      </div>
                    </div>

                    <%= sf.hidden_field :wday, value: wday %>
                    <%= sf.hidden_field :category, value: @category %>
                  <% end %>
                </div>

                <%= link_to profile_availability_slot_path(slot),
                  data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
                  class: "btn btn-ghost btn-square text-gray-400 hover:text-rose-500" do %>
                  <span class="material-icons-outlined">delete</span>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <div class="p-8 flex items-center justify-center text-gray-400 gap-2">
              <span class="material-icons-outlined text-xl">schedule</span>
              <span class="text-sm">まだ時間が登録されていません</span>
            </div>
          <% end %>
        </div>

        <%# ★テンプレート（曜日ごと）。JSが __KEY__ を new_... に置換して data-slot-list に append します。 %>
        <template data-slot-template="<%= wday %>">
          <div class="flex items-end gap-3 js-slot-row">
            <div class="flex-1 grid gap-4 sm:grid-cols-2">
              <input type="hidden" name="slots[__KEY__][wday]" value="<%= wday %>">
              <input type="hidden" name="slots[__KEY__][category]" value="<%= @category %>">

              <div>
                <label class="label">
                  <span class="label-text text-xs font-semibold tracking-wide text-gray-500">開始時刻</span>
                </label>
                <div class="relative">
                  <select name="slots[__KEY__][start_time]" class="select select-bordered w-full pr-10">
                    <option value=""></option>
                    <% time_options.each do |label, val| %>
                      <option value="<%= val %>"><%= label %></option>
                    <% end %>
                  </select>
                  <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-gray-400">
                    <span class="material-icons-outlined text-base">schedule</span>
                  </div>
                </div>
              </div>

              <div>
                <label class="label">
                  <span class="label-text text-xs font-semibold tracking-wide text-gray-500">終了時刻</span>
                </label>
                <div class="relative">
                  <select name="slots[__KEY__][end_time]" class="select select-bordered w-full pr-10">
                    <option value=""></option>
                    <% end_time_options.each do |label, val| %>
                      <option value="<%= val %>"><%= label %></option>
                    <% end %>
                  </select>
                  <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-gray-400">
                    <span class="material-icons-outlined text-base">schedule</span>
                  </div>
                </div>
              </div>
            </div>

            <%# 未保存行なので、DB削除ではなくDOMから除去 %>
            <button type="button"
                    class="btn btn-ghost btn-square text-gray-400 hover:text-rose-500"
                    data-action="click->availability-slots#remove">
              <span class="material-icons-outlined">delete</span>
            </button>
          </div>
        </template>
      </div>
    <% end %>

    <%# ===== 保存ボタン（スティッキーフッター） ===== %>
    <% other_category = (@category == "tech" ? "community" : "tech") %>
    <% confirm_msg = "「#{Theme.human_enum_name(:category, other_category)}」を現在の入力内容で上書きします。よろしいですか？" %>

  <% end %>
</div>

<%# ===== スティッキー保存ボタン（フォーム外） ===== %>
<div class="sticky bottom-0 bg-white border-t border-gray-200 p-4 z-40">
  <div class="max-w-4xl mx-auto flex flex-col sm:flex-row justify-center items-center gap-4">
    <% other_category = (@category == "tech" ? "community" : "tech") %>
    <% confirm_msg = "「#{Theme.human_enum_name(:category, other_category)}」を現在の入力内容で上書きします。よろしいですか？" %>

    <button type="submit"
            form="weekly-availability-form"
            formaction="<%= overwrite_copy_category_profile_availability_slots_path %>"
            name="from_category"
            value="<%= @category %>"
            class="w-full sm:w-auto px-8 py-3 bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-lg shadow-sm transition-colors flex items-center justify-center gap-2"
            onclick="<%= "return confirm(#{confirm_msg.to_json})" %>">
      <%= "#{Theme.human_enum_name(:category, other_category)}へ上書きコピー" %>
    </button>
  
    <button type="submit"
            form="weekly-availability-form"
            class="w-full sm:w-auto px-12 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-lg shadow-indigo-600/30 transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
      <span class="material-icons-outlined">save</span>
      保存する
    </button>
    
    <button type="submit"
        form="weekly-availability-form"
        name="after_save"
        value="themes"
        class="w-full sm:w-auto px-12 py-3 bg-violet-600 hover:bg-violet-700 text-white font-bold rounded-lg shadow-lg shadow-violet-600/30 transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
      <span class="material-icons-outlined">save</span>
      保存して掲示板一覧へ
    </button>
    
  </div>
</div>