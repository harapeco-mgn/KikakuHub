<%# ========== 曜日（0=月, ... 6=日）に統一 ========== %>
<% wday_en = %w[Monday Tuesday Wednesday Thursday Friday Saturday Sunday] %>
<% wday_jp = %w[月曜日 火曜日 水曜日 木曜日 金曜日 土曜日 日曜日] %>
<% wdays_order = (0..6).to_a %>

<%# ========== 時刻オプション（30分刻み） ========== %>
<% time_options =
  (0..47).map do |i|
    m = i * 30
    label = format("%02d:%02d", m / 60, m % 60)
    [label, label]
  end
%>
<% end_time_options = time_options + [["24:00", "24:00"]] %>

<%# ========== start_minute/end_minute を "HH:MM" に変換して selected を確実に当てる ========== %>
<% minute_to_hhmm = ->(m) { format("%02d:%02d", m / 60, m % 60) } %>
<% selected_hhmm = ->(obj, minute_attr, fallback_attr) do
  if obj.respond_to?(minute_attr) && !obj.public_send(minute_attr).nil?
    minute_to_hhmm.call(obj.public_send(minute_attr))
  else
    obj.public_send(fallback_attr).to_s
  end
end %>

<%# controller でセットされる想定 %>
<% @category ||= (params[:category].presence || "tech") %>
<% @slots_by_wday ||= {} %>

<div class="mx-auto max-w-4xl px-4 py-8 space-y-6"
     data-controller="availability-draft availability-slots"
     data-availability-draft-category-value="<%= @category %>"
     data-availability-draft-clear-value="<%= flash[:notice].present? %>">

  <%# ===== 説明カード ===== %>
  <div class="card bg-gradient-to-br from-primary/5 to-secondary/5 shadow-lg ring-1 ring-primary/20">
    <div class="card-body py-4 sm:py-6">
      <h1 class="text-xl font-bold sm:text-2xl">参加可能時間の登録</h1>
      <p class="text-sm text-base-content/70 leading-relaxed">
        毎週参加できる時間帯を曜日ごとに登録してください。
        <span class="text-primary font-medium">登録した時間帯は人数集計としてのみ表示</span>され、個人の予定は公開されません。
      </p>
    </div>
  </div>

  <%# ===== カテゴリ切り替えタブ（説明カードの下に配置） ===== %>
  <div class="flex flex-col gap-3">
    <p class="text-sm font-semibold text-base-content/70 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
      カテゴリを選択してください
    </p>
    <div class="grid grid-cols-2 gap-3 sm:gap-4">
      <%= link_to profile_availability_slots_path(category: "tech"),
        class: "group relative flex flex-col items-center justify-center gap-2 p-4 sm:p-5 rounded-xl border-2 transition-all duration-200 #{@category == 'tech' ? 'bg-primary text-primary-content border-primary shadow-lg shadow-primary/25 scale-[1.02]' : 'bg-base-100 border-base-300 hover:border-primary/50 hover:bg-primary/5'}",
        data: { action: "click->availability-draft#switch", category: "tech" } do %>
        <% if @category == 'tech' %>
          <span class="absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-primary-content text-primary text-xs font-bold shadow">
            ✓
          </span>
        <% end %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sm:h-8 sm:w-8 <%= @category == 'tech' ? '' : 'text-primary' %>" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
          <line x1="8" y1="21" x2="16" y2="21"></line>
          <line x1="12" y1="17" x2="12" y2="21"></line>
        </svg>
        <span class="font-bold text-sm sm:text-base"><%= Theme.human_enum_name(:category, "tech") %></span>
        <span class="text-xs <%= @category == 'tech' ? 'text-primary-content/80' : 'text-base-content/50' %>">技術勉強会向け</span>
      <% end %>

      <%= link_to profile_availability_slots_path(category: "community"),
        class: "group relative flex flex-col items-center justify-center gap-2 p-4 sm:p-5 rounded-xl border-2 transition-all duration-200 #{@category == 'community' ? 'bg-secondary text-secondary-content border-secondary shadow-lg shadow-secondary/25 scale-[1.02]' : 'bg-base-100 border-base-300 hover:border-secondary/50 hover:bg-secondary/5'}",
        data: { action: "click->availability-draft#switch", category: "community" } do %>
        <% if @category == 'community' %>
          <span class="absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-secondary-content text-secondary text-xs font-bold shadow">
            ✓
          </span>
        <% end %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sm:h-8 sm:w-8 <%= @category == 'community' ? '' : 'text-secondary' %>" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <span class="font-bold text-sm sm:text-base"><%= Theme.human_enum_name(:category, "community") %></span>
        <span class="text-xs <%= @category == 'community' ? 'text-secondary-content/80' : 'text-base-content/50' %>">交流イベント向け</span>
      <% end %>
    </div>
  </div>

  <% if flash[:alert].present? %>
    <div class="alert alert-error"><div><%= flash[:alert] %></div></div>
  <% end %>

  <%# ===== 一括保存フォーム（Turbo無効で安定） ===== %>
  <%= form_with url: bulk_update_profile_availability_slots_path,
                method: :patch,
                id: "weekly-availability-form",
                local: true,
                class: "space-y-6" do %>

    <%= hidden_field_tag :category, @category %>

    <% wdays_order.each do |wday| %>
      <% slots = (@slots_by_wday[wday] || []) %>

      <div class="rounded-2xl border border-base-300 bg-base-100 shadow-sm overflow-hidden">
        <div class="flex items-center justify-between bg-base-200/50 px-6 py-4">
          <h2 class="text-base font-bold"><%= "#{wday_en[wday]} / #{wday_jp[wday]}" %></h2>

          <button type="button"
                  class="btn btn-ghost btn-sm text-primary gap-1 hover:bg-primary/10"
                  data-action="click->availability-slots#add"
                  data-availability-slots-wday-param="<%= wday %>">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="16"></line>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            時間を追加
          </button>
        </div>

        <%# ★追加先：この div に行をappendする %>
        <div class="px-6 py-6 space-y-4" data-slot-list="<%= wday %>">
          <%# ===== 既存スロット（編集 + 削除） ===== %>
          <% if slots.any? %>
            <% slots.each do |slot| %>
              <div class="flex items-end gap-3">
                <div class="flex-1 grid gap-4 sm:grid-cols-2">
                  <%= fields_for "slots[#{slot.id}]", slot do |sf| %>
                    <div>
                      <label class="label">
                        <span class="label-text text-xs font-semibold tracking-wide text-base-content/70">開始時刻</span>
                      </label>
                      <div class="relative">
                        <%= sf.select :start_time, time_options,
                          { selected: selected_hhmm.call(sf.object, :start_minute, :start_time) },
                          class: "select select-bordered w-full pr-10" %>
                        <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-base-content/50">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="9"></circle>
                            <path d="M12 7v5l3 2"></path>
                          </svg>
                        </div>
                      </div>
                    </div>

                    <div>
                      <label class="label">
                        <span class="label-text text-xs font-semibold tracking-wide text-base-content/70">終了時刻</span>
                      </label>
                      <div class="relative">
                        <%= sf.select :end_time, end_time_options,
                          { selected: selected_hhmm.call(sf.object, :end_minute, :end_time) },
                          class: "select select-bordered w-full pr-10" %>
                        <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-base-content/50">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="9"></circle>
                            <path d="M12 7v5l3 2"></path>
                          </svg>
                        </div>
                      </div>
                    </div>

                    <%= sf.hidden_field :wday, value: wday %>
                    <%= sf.hidden_field :category, value: @category %>
                  <% end %>
                </div>

                <%= link_to profile_availability_slot_path(slot),
                  data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
                  class: "btn btn-ghost btn-square" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18"></path>
                    <path d="M8 6V4h8v2"></path>
                    <path d="M19 6l-1 14H6L5 6"></path>
                    <path d="M10 11v6"></path>
                    <path d="M14 11v6"></path>
                  </svg>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <p class="text-sm text-base-content/50 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              まだ時間が登録されていません
            </p>
          <% end %>
        </div>

        <%# ★選択2：初期の空行は廃止。Add Slotでのみ追加する。 %>
        <%# ★テンプレート（曜日ごと）。JSが __KEY__ を new_... に置換して data-slot-list に append します。 %>
        <template data-slot-template="<%= wday %>">
          <div class="flex items-end gap-3 js-slot-row">
            <div class="flex-1 grid gap-4 sm:grid-cols-2">
              <input type="hidden" name="slots[__KEY__][wday]" value="<%= wday %>">
              <input type="hidden" name="slots[__KEY__][category]" value="<%= @category %>">

              <div>
                <label class="label">
                  <span class="label-text text-xs font-semibold tracking-wide text-base-content/70">開始時刻</span>
                </label>
                <div class="relative">
                  <select name="slots[__KEY__][start_time]" class="select select-bordered w-full pr-10">
                    <option value=""></option>
                    <% time_options.each do |label, val| %>
                      <option value="<%= val %>"><%= label %></option>
                    <% end %>
                  </select>
                  <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-base-content/50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="9"></circle>
                      <path d="M12 7v5l3 2"></path>
                    </svg>
                  </div>
                </div>
              </div>

              <div>
                <label class="label">
                  <span class="label-text text-xs font-semibold tracking-wide text-base-content/70">終了時刻</span>
                </label>
                <div class="relative">
                  <select name="slots[__KEY__][end_time]" class="select select-bordered w-full pr-10">
                    <option value=""></option>
                    <% end_time_options.each do |label, val| %>
                      <option value="<%= val %>"><%= label %></option>
                    <% end %>
                  </select>
                  <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-base-content/50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="9"></circle>
                      <path d="M12 7v5l3 2"></path>
                    </svg>
                  </div>
                </div>
              </div>
            </div>

            <%# 未保存行なので、DB削除ではなくDOMから除去 %>
            <button type="button"
                    class="btn btn-ghost btn-square"
                    data-action="click->availability-slots#remove">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"></path>
                <path d="M8 6V4h8v2"></path>
                <path d="M19 6l-1 14H6L5 6"></path>
                <path d="M10 11v6"></path>
                <path d="M14 11v6"></path>
              </svg>
            </button>
          </div>
        </template>
      </div>
    <% end %>

    <%# ===== 保存ボタン（フォーム最下部） ===== %>
    <div class="sticky bottom-4 z-10 flex justify-center pt-4">
      <button type="submit" class="btn btn-primary btn-lg px-10 gap-2 shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
          <polyline points="17 21 17 13 7 13 7 21"></polyline>
          <polyline points="7 3 7 8 15 8"></polyline>
        </svg>
        保存する
      </button>
    </div>
  <% end %>
</div>