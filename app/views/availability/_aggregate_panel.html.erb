<% show_category_select = local_assigns.fetch(:show_category_select, true) %>

<% wday_labels = AvailabilityHelper::WDAY_LABELS %>

<% cohort_options = Array(cohort_options).compact %>
<% selected_cohort = cohort.to_s %>
<% selected_category = category.to_s %>

<% safe_counts = counts.presence || Array.new(7) { Array.new(48, 0) } %>

<div class="rounded-lg border border-base-300 bg-base-100 p-4 shadow-sm">
  <div class="mb-3 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <h2 class="text-lg font-bold">参加可能時間（集計）</h2>

    <%= form_with url: url,
              method: :get,
              data: { turbo_frame: "availability_aggregate", controller: "auto-submit" },
              class: "flex flex-wrap items-center gap-2" do %>
      <label class="text-sm text-base-content/60">期</label>
      <% cohort_select_options =
           [["全員", "all"]] + cohort_options.map { |n| ["#{n}期", n.to_s] }
      %>
      <%= select_tag :cohort,
      options_for_select(cohort_select_options, selected_cohort),
      class: "select select-bordered select-sm",
      data: { action: "change->auto-submit#submit" } %>

      <% if show_category_select %>
        <label class="text-sm text-base-content/60">カテゴリ</label>
        <%= select_tag :category,
      options_for_select(
        Theme.categories.keys.map { |k| [Theme.human_enum_name(:category, k), k] },
        selected_category
      ),
      class: "select select-bordered select-sm",
      data: { action: "change->auto-submit#submit" } %>
      <% else %>
        <%= hidden_field_tag :category, selected_category %>
        <span class="text-sm text-base-content/60">カテゴリ</span>
        <span class="text-sm font-medium">
          <%= selected_category.present? ?
                I18n.t("activerecord.attributes.theme.categories.#{selected_category}") :
                "未選択" %>
        </span>
      <% end %>
      <noscript>
        <div class="mt-2">
          <%= submit_tag "表示", class: "btn btn-sm" %>
        </div>
      </noscript>
    <% end %>
  </div>

  <%# 凡例（レジェンド） %>
  <div class="mb-3 flex flex-wrap items-center gap-3 text-xs">
    <span class="text-base-content/60 font-medium">凡例:</span>
    <span class="inline-flex items-center gap-1">
      <span class="inline-block h-4 w-4 rounded border border-base-300 bg-base-100"></span>
      <span class="text-base-content/60">0人</span>
    </span>
    <span class="inline-flex items-center gap-1">
      <span class="inline-block h-4 w-4 rounded border border-sky-200 bg-sky-100"></span>
      <span>1-2人</span>
    </span>
    <span class="inline-flex items-center gap-1">
      <span class="inline-block h-4 w-4 rounded border border-sky-300 bg-sky-300"></span>
      <span>3-5人</span>
    </span>
    <span class="inline-flex items-center gap-1">
      <span class="inline-block h-4 w-4 rounded border border-sky-500 bg-sky-500"></span>
      <span>6-8人</span>
    </span>
    <span class="inline-flex items-center gap-1">
      <span class="inline-block h-4 w-4 rounded border border-sky-700 bg-sky-700"></span>
      <span>9人+</span>
    </span>
  </div>

  <%# ガントチャート風表示 %>
  <div class="overflow-x-auto rounded-lg border-2 border-base-300">
    <table class="w-full border-collapse" style="min-width: 900px;">
      <%# ヘッダー（2時間単位、4列結合） %>
      <thead>
        <tr class="bg-base-200">
          <th rowspan="2" class="border-r-2 border-b-2 border-base-300 px-2 py-2 text-sm font-bold text-center w-12">曜日</th>
          <% 0.step(22, 2) do |hour| %>
            <th colspan="4" class="border-r-2 border-b border-base-300 py-1 text-center text-xs font-bold <%= hour % 6 == 0 ? 'bg-base-300/50' : '' %>">
              <%= hour %>〜<%= hour + 2 %>時
            </th>
          <% end %>
        </tr>
        <%# サブヘッダー（30分単位） %>
        <tr class="bg-base-200/50">
          <% 0.upto(47) do |slot| %>
            <% hour = slot / 2 %>
            <% minute = (slot % 2) * 30 %>
            <% is_block_start = slot % 4 == 0 %>
            <th class="<%= is_block_start ? 'border-l-2 border-l-base-300' : 'border-l border-l-base-300/30' %> border-b-2 border-r border-r-base-300/30 border-base-300 py-1 text-center text-[10px] font-normal text-base-content/60" style="min-width: 18px;">
              <%= minute == 0 ? format("%d", hour) : '' %>
            </th>
          <% end %>
        </tr>
      </thead>

      <%# 各曜日の行 %>
      <tbody>
        <% 0.upto(6) do |wday| %>
          <tr class="hover:bg-base-100/30 transition-colors">
            <%# 曜日ラベル %>
            <th class="border-r-2 border-b-2 border-base-300 px-2 py-2 text-sm font-bold bg-base-200 text-center <%= [0, 6].include?(wday) ? 'text-error' : '' %>">
              <%= wday_labels[wday] %>
            </th>

            <%# 時間枠（30分単位） %>
            <% 0.upto(47) do |slot| %>
              <% count = safe_counts[wday][slot] %>
              <% hour = slot / 2 %>
              <% minute = (slot % 2) * 30 %>
              <% time_label = format("%02d:%02d", hour, minute) %>
              <% is_block_start = slot % 4 == 0 %>
              <td class="<%= is_block_start ? 'border-l-2 border-l-base-300' : 'border-l border-l-base-300/30' %> border-b-2 border-base-300 p-0 text-center">
                <div class="group relative h-10 w-full <%= aggregate_cell_class_for_count(count) %> flex items-center justify-center cursor-default transition-all hover:brightness-110 hover:z-10">
                  <% if count > 0 %>
                    <span class="font-bold text-xs"><%= count %></span>
                  <% end %>

                  <%# カスタムツールチップ（下に表示） %>
                  <div class="absolute top-full left-1/2 -translate-x-1/2 mt-2 px-3 py-2 bg-neutral text-neutral-content text-xs rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-[100] whitespace-nowrap pointer-events-none">
                    <%# 上向き矢印 %>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 border-4 border-transparent border-b-neutral"></div>
                    <div class="font-bold text-sm"><%= wday_labels[wday] %>曜日 <%= time_label %></div>
                    <div class="mt-1">参加可能: <span class="text-sky-400 font-bold"><%= count %>人</span></div>
                  </div>
                </div>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>

      <%# フッター（2時間単位） %>
      <tfoot>
        <tr class="bg-base-200">
          <th class="border-r-2 border-base-300 px-2 py-1 text-sm font-bold text-center">時間</th>
          <% 0.step(22, 2) do |hour| %>
            <th colspan="4" class="border-r-2 border-base-300 py-1 text-center text-xs font-bold <%= hour % 6 == 0 ? 'bg-base-300/50' : '' %>">
              <%= hour %>〜<%= hour + 2 %>時
            </th>
          <% end %>
        </tr>
      </tfoot>
    </table>
  </div>

  <p class="mt-2 text-xs text-base-content/60">
    各セルは30分の枠を表示。マウスを乗せると詳細が確認できます。
  </p>
</div>