<div class="mx-auto max-w-3xl px-4 py-8">
  <div class="mb-4">
    <%= link_to "← 一覧へ戻る", themes_path, class: "text-sm text-gray-600 hover:underline" %>
  </div>

  <!-- テーマ本体 -->
  <div class="rounded-2xl border bg-white p-6 shadow-sm">
    <header class="flex items-start justify-between gap-6">
      <div class="min-w-0">
        <p class="text-xs text-gray-500">
          <span class="rounded-full bg-gray-100 px-2 py-1"><%= @theme.category %></span>
          <span class="mx-1">・</span>
          投稿者：<%= @theme.user&.email || "unknown" %>
          <span class="mx-1">・</span>
          <%= l(@theme.created_at, format: :short) rescue @theme.created_at.to_s %>
        </p>

        <h1 class="mt-2 text-2xl font-bold"><%= @theme.title %></h1>
      </div>

      <!-- 投票エリア（右上） -->
      <div class="shrink-0 text-right">
        <div class="text-sm text-gray-700">
          投票数: <span class="font-semibold"><%= @theme.theme_votes.count %></span>
        </div>

        <div class="mt-2">
          <% if user_signed_in? %>
            <% voted = current_user.theme_votes.exists?(theme: @theme) %>

            <% if voted %>
              <%= button_to "取消",
                theme_vote_path(@theme),
                method: :delete,
                class: "rounded border px-3 py-1 text-sm",
                form_class: "inline" %>
            <% else %>
              <%= button_to "投票",
                theme_vote_path(@theme),
                method: :post,
                class: "rounded bg-black px-3 py-1 text-sm text-white",
                form_class: "inline" %>
            <% end %>
          <% else %>
            <%= link_to "ログインして投票",
              new_user_session_path,
              class: "text-sm underline text-gray-700" %>
          <% end %>
        </div>
      </div>
    </header>

    <div class="mt-6 whitespace-pre-wrap text-gray-800">
      <%= @theme.description %>
    </div>
  </div>

  <!-- コメント -->
  <div class="mt-6 rounded-2xl border bg-white p-6 shadow-sm">
    <h2 class="text-lg font-semibold">コメント</h2>

    <% if @theme_comment&.errors&.any? %>
      <div class="mt-3 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-800">
        <p class="font-medium">入力内容を確認してください</p>
        <ul class="mt-1 list-disc pl-5">
          <% @theme_comment.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="mt-4">
      <%= form_with model: [@theme, @theme_comment], class: "space-y-3" do |f| %>
        <%= f.text_area :body,
          rows: 4,
          placeholder: "補足や温度感などを書いてください",
          class: "w-full rounded-md border-gray-300 focus:border-gray-400 focus:ring-gray-400" %>

        <div class="flex items-center justify-end">
          <%= f.submit "コメントする", class: "rounded-md bg-black px-4 py-2 text-sm text-white" %>
        </div>
      <% end %>
    </div>
    <% if user_signed_in? %>
  <% current_status = @rsvp&.status %>
  <% secondary_on   = @rsvp&.secondary_interest? || false %>

  <% base_btn   = "px-3 py-2 rounded border text-sm" %>
  <% active_btn = "bg-gray-900 text-white border-gray-900" %>
  <% idle_btn   = "bg-white text-gray-700 border-gray-300 hover:bg-gray-50" %>

  <% btn_class = ->(active) { [base_btn, (active ? active_btn : idle_btn)].join(" ") } %>

  <div class="mt-4 space-y-2">
    <div class="flex flex-wrap gap-2">
      <%= button_to "参加",
            theme_rsvp_path(@theme),
            method: :patch,
            params: { rsvp: { status: :attending } },
            class: btn_class.call(current_status == "attending") %>

      <%= button_to "不参加",
            theme_rsvp_path(@theme),
            method: :patch,
            params: { rsvp: { status: :not_attending } },
            class: btn_class.call(current_status == "not_attending") %>

      <%= button_to "未定",
            theme_rsvp_path(@theme),
            method: :patch,
            params: { rsvp: { status: :undecided } },
            class: btn_class.call(current_status == "undecided") %>
    </div>

    <% if @theme.secondary_enabled? %>
      <% secondary_label = @theme.secondary_label.presence || "第2ボタン" %>
      <% next_secondary  = !secondary_on %>

      <%= button_to "#{secondary_label}（#{secondary_on ? "ON" : "OFF"}）",
            theme_rsvp_path(@theme),
            method: :patch,
            params: { rsvp: { secondary_interest: next_secondary } },
            class: btn_class.call(secondary_on) %>
    <% end %>
  </div>
    <% else %>
      <p class="mt-4 text-sm text-gray-600">参加状態の変更にはログインが必要です。</p>
    <% end %>

    <div class="mt-6 border-t pt-4">
      <% if @theme_comments.any? %>
        <div class="space-y-4">
          <%= render @theme_comments %>
        </div>
      <% else %>
        <p class="text-sm text-gray-600">まだコメントはありません。</p>
      <% end %>
    </div>
  </div>
</div>